//-----------------------------------------------------------------------------*
// Copyright © 2024 Nigel Winterbottom.
// FILE			: CharacterLcd.c
// ENCODING		: ISO 8859-1
// DESCRIPTION	: Hitachi HD44780 LCD Controller Simulator.
// CREATED		: 2023-04-10
// AUTHOR		: Nigel Winterbottom
// CPU TYPE		: ANY
// COMPILER		: ANY
// COMMENTS		:
//-----------------------------------------------------------------------------*


/* Implements *****************************************************************/
#include "CharacterLcd.h"

/* Dependencies ***************************************************************/
#include <stdint.h>
#include <stdbool.h>

#include "SegmentView.h"


/* Local Defines **************************************************************/
#define MemoryPerRow 40


/* Local Types ****************************************************************/
/* Local Variables ************************************************************/


/* Local Functions ************************************************************/
static void UpdateLcd  (CharacterLcd_t * self);
static void DrawPixels (CharacterLcd_t * self, uint8_t index);



/* Public Functions ***********************************************************/

void charlcd_CreateController (CharacterLcd_t * self, SegmentView * view)
{
	self->view = view;
	charlcd_SetNrLines(self, 1);

	charlcd_ClearDisplay (self);

	for (WORD segment = 0; segment < 400; segment++) {
		segview_StoreSegment(self->view, segment, 0xff, 0);
		segview_StoreSegment(self->view, segment, 0x00, 1);
	}
}


void charlcd_SetNrLines (CharacterLcd_t * self, int n)
{
	self->bTwoLineMode = (n == 2);
}

uint8_t charlcd_GetDD_RAM (CharacterLcd_t * self, uint8_t index)
{
	if (index >= 80)
		return 0xff;

	return self->DD_RAM[index];
}

void charlcd_SetDD_RAM (CharacterLcd_t * self, uint8_t index, uint8_t data)
{
	if (index >= 80)
		return;

	self->DD_RAM[index] = data;
	DrawPixels(self, index);
}

uint8_t charlcd_GetCG_RAM (CharacterLcd_t * self, uint8_t index)
{
	return self->CG_RAM[index & 63];
}

void charlcd_SetCG_RAM (CharacterLcd_t * self, uint8_t index, uint8_t data)
{
	self->CG_RAM[index & 63] = data;
	UpdateLcd(self); // Let's simply Update the whole LCD to "forward" any font change onto the view.
}


void charlcd_SetDisplay (CharacterLcd_t * self, bool blinkOn, bool cursorOn, bool displayOn)
{
	self->bBlnkOn    = blinkOn;
	self->bCursonOn  = cursorOn;
	self->bDisplayOn = displayOn;
}

void charlcd_ScrollDisplay (CharacterLcd_t * self, uint8_t offset)
{
	self->ScrollOffset += offset;
	while (self->ScrollOffset < 0)             self->ScrollOffset += MemoryPerRow;
	while (self->ScrollOffset >= MemoryPerRow) self->ScrollOffset -= MemoryPerRow;

	UpdateLcd(self);
}

void charlcd_ScrollCursor (CharacterLcd_t * self, uint8_t offset)
{
	self->CursorX += offset;
	while (self->CursorX < 0)             { self->CursorX += MemoryPerRow; self->CursorY = (self->CursorY + 1) & 1; }
	while (self->CursorX >= MemoryPerRow) { self->CursorX -= MemoryPerRow; self->CursorY = (self->CursorY + 1) & 1; }
}

void charlcd_CursorHome (CharacterLcd_t * self)
{
	self->CursorX = 0;
	self->CursorY = 0;
	self->ScrollOffset = 0;
}

void charlcd_ClearDisplay (CharacterLcd_t * self)
{
	memset(self->DD_RAM, ' ', sizeof self->DD_RAM);
	charlcd_CursorHome(self);
}


/* Local Functions ************************************************************/


void UpdateLcd (CharacterLcd_t * self)
{
	for (uint8_t y = 0; y < (self->bTwoLineMode ? 2 : 1); ++y)
	{
		uint8_t memAddr = self->ScrollOffset;
		for (uint8_t x = 0; x < MemoryPerRow; ++x) {
			DrawPixels (self, memAddr);
		}
	}
}


/**
 * @fn		DrawPixels
 * @brief	Draw one 5x7-Pixel Character.
 * @param	segmentIdx: 0x00 - 0x27.
 */
static void DrawPixels (CharacterLcd_t * self, uint8_t index)
{

	/* (ROM Code : A00) Japanese */
	static const uint8_t fontA00[240][8] = {

		{ 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x1f, 0x00 },  //  ' ± ' U+00B1 Plus & Minus
		{ 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00 },  //  ' = ' U+2251 Identical To (3 Horizontal Bars)
		{ 0x1f, 0x11, 0x11, 0x09, 0x08, 0x08, 0x04, 0x04 },  //  ' - ' U+23B2 Summation Top
		{ 0x02, 0x04, 0x04, 0x04, 0x08, 0x08, 0x09, 0x11 },  //  ' - ' U+23B3 Summation Bottom
		{ 0x01, 0x02, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04 },  //  ' - ' U+23A7 Left Curly Bracket Upper Hook.
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x02 },  //  ' - ' U+23A9 Left Curly Bracket Lower Hook.
		{ 0x10, 0x08, 0x08, 0x04, 0x04, 0x04, 0x04, 0x04 },  //  ' - ' U+23AB Right Curly Bracket Upper Hook.
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x08 },  //  ' - ' U+23AD Right Curly Bracket Lower Hook.
		{ 0x01, 0x02, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 },  //  ' - ' U+23B0 Curly Bracket Section
		{ 0x10, 0x08, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 },  //  ' - ' U+23B1 Curly Bracket Section
		{ 0x00, 0x0A, 0x14, 0x00, 0x0A, 0x14, 0x00, 0x00 },  //  ' - ' U+2248 Approx Equals
		{ 0x03, 0x05, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04 },  //  ' - ' U+222B Integral
		{ 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00 },  //  ' - ' U+FE66 Small Equals
		{ 0x00, 0x00, 0x08, 0x15, 0x15, 0x02, 0x00, 0x00 },  //  ' - ' U+223C Tilde Operator
		{ 0x1c, 0x04, 0x1c, 0x10, 0x1c, 0x00, 0x00, 0x00 },  //  ' - ' U+00B2 Superscript Two
		{ 0x1c, 0x04, 0x1c, 0x04, 0x1c, 0x00, 0x00, 0x00 },  //  ' - ' U+00B3 Superscript Three

		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },  //  '   '  0x20
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x00 },  //  ' ! '  0x21
		{ 0x00, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00 },  //  ' " '  0x22
		{ 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a, 0x00 },  //  ' # '
		{ 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04, 0x00 },  //  ' $ '
		{ 0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03, 0x00 },  //  ' % '
		{ 0x0c, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0d, 0x00 },  //  ' & '
		{ 0x0c, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00 },  //  ' ' '
		{ 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0x00 },  //  ' ( '
		{ 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00 },  //  ' ) '
		{ 0x00, 0x04, 0x15, 0x0e, 0x15, 0x04, 0x00, 0x00 },  //  ' * '
		{ 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x00 },  //  ' + '
		{ 0x00, 0x00, 0x00, 0x00, 0x0c, 0x04, 0x08, 0x00 },  //  ' , '
		{ 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0x00 },  //  ' - '
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x00 },  //  ' . '
		{ 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00, 0x00 },  //  ' / '
		{ 0x0e, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0e, 0x00 },  //  ' 0 '  0x30
		{ 0x04, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00 },
		{ 0x0e, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1f, 0x00 },
		{ 0x1f, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0e, 0x00 },
		{ 0x02, 0x06, 0x0a, 0x12, 0x1f, 0x02, 0x02, 0x00 },
		{ 0x1f, 0x10, 0x1e, 0x01, 0x01, 0x11, 0x0e, 0x00 },
		{ 0x06, 0x08, 0x10, 0x1e, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x1f, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08, 0x00 },
		{ 0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x0e, 0x11, 0x11, 0x0f, 0x01, 0x02, 0x0c, 0x00 },  //  ' 9 '
		{ 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x0c, 0x00, 0x00 },  //  ' : '
		{ 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08, 0x00 },  //  ' ; '
		{ 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x00 },  //  ' < '
		{ 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00, 0x00 },  //  ' = '
		{ 0x10, 0x08, 0x04, 0x02, 0x04, 0x08, 0x10, 0x00 },  //  ' > '
		{ 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0x00 },  //  ' ? '
		{ 0x0e, 0x11, 0x01, 0x0d, 0x15, 0x15, 0x0e, 0x00 },  //  ' @ '  0x40
		{ 0x0e, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x00 },  //  ' A '  0x41
		{ 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0x00 },
		{ 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0x00 },
		{ 0x1e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1e, 0x00 },
		{ 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x1f, 0x00 },
		{ 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x10, 0x00 },
		{ 0x0e, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0f, 0x00 },
		{ 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x00 },
		{ 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00 },
		{ 0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c, 0x00 },
		{ 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0x00 },
		{ 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0x00 },
		{ 0x11, 0x1b, 0x15, 0x15, 0x11, 0x11, 0x11, 0x00 },
		{ 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0x00 },
		{ 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10, 0x00 },
		{ 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d, 0x00 },
		{ 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11, 0x00 },
		{ 0x0f, 0x10, 0x10, 0x0e, 0x01, 0x01, 0x1e, 0x00 },
		{ 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 },
		{ 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00 },
		{ 0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0a, 0x00 },
		{ 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0x00 },
		{ 0x11, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0x00 },
		{ 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f, 0x00 },
		{ 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e, 0x00 },
		{ 0x11, 0x0a, 0x1f, 0x04, 0x1f, 0x04, 0x04, 0x00 },
		{ 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e, 0x00 },
		{ 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00 },
		{ 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f, 0x00 },
		{ 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1e, 0x00 },
		{ 0x00, 0x00, 0x0e, 0x10, 0x10, 0x11, 0x0e, 0x00 },
		{ 0x01, 0x01, 0x0d, 0x13, 0x11, 0x11, 0x0f, 0x00 },
		{ 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0e, 0x00 },
		{ 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08, 0x00 },
		{ 0x00, 0x00, 0x0f, 0x11, 0x0f, 0x01, 0x0e, 0x00 },
		{ 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00 },
		{ 0x04, 0x00, 0x0c, 0x04, 0x04, 0x04, 0x0e, 0x00 },
		{ 0x02, 0x06, 0x02, 0x02, 0x02, 0x12, 0x0c, 0x00 },
		{ 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0x00 },
		{ 0x0c, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x00 },
		{ 0x00, 0x00, 0x1a, 0x15, 0x15, 0x11, 0x11, 0x00 },
		{ 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00 },
		{ 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x00, 0x00, 0x1e, 0x11, 0x1e, 0x10, 0x10, 0x00 },
		{ 0x00, 0x00, 0x0d, 0x13, 0x0f, 0x01, 0x01, 0x00 },
		{ 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0x00 },
		{ 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e, 0x00 },
		{ 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06, 0x00 },
		{ 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00 },
		{ 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x00 },
		{ 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a, 0x00 },
		{ 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x00 },
		{ 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x0e, 0x00 },
		{ 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f, 0x00 },
		{ 0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02, 0x00 },
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00 },
		{ 0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08, 0x00 },
		{ 0x00, 0x04, 0x02, 0x1f, 0x02, 0x04, 0x00, 0x00 },
		{ 0x00, 0x04, 0x08, 0x1f, 0x08, 0x04, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // CharCode 0x80
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x1c, 0x14, 0x1c, 0x00 },
		{ 0x07, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x1c, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0x00 },
		{ 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x1f, 0x01, 0x02, 0x04, 0x00 },
		{ 0x00, 0x00, 0x1f, 0x01, 0x06, 0x04, 0x08, 0x00 },
		{ 0x00, 0x00, 0x02, 0x04, 0x0c, 0x14, 0x04, 0x00 },
		{ 0x00, 0x00, 0x04, 0x1f, 0x11, 0x01, 0x06, 0x00 },
		{ 0x00, 0x00, 0x00, 0x1f, 0x04, 0x04, 0x1f, 0x00 },
		{ 0x00, 0x00, 0x02, 0x1f, 0x06, 0x0a, 0x12, 0x00 },
		{ 0x00, 0x00, 0x08, 0x1f, 0x09, 0x0a, 0x08, 0x00 },
		{ 0x00, 0x00, 0x00, 0x0e, 0x02, 0x02, 0x1f, 0x00 },
		{ 0x00, 0x00, 0x1e, 0x02, 0x1e, 0x02, 0x1e, 0x00 },
		{ 0x00, 0x00, 0x00, 0x15, 0x15, 0x01, 0x06, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00 },
		{ 0x1f, 0x01, 0x05, 0x06, 0x04, 0x04, 0x08, 0x00 },
		{ 0x01, 0x02, 0x04, 0x0c, 0x14, 0x04, 0x04, 0x00 },
		{ 0x04, 0x1f, 0x11, 0x11, 0x01, 0x02, 0x04, 0x00 },
		{ 0x00, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x1f, 0x00 },
		{ 0x02, 0x1f, 0x02, 0x06, 0x0a, 0x12, 0x02, 0x00 },
		{ 0x08, 0x1f, 0x09, 0x09, 0x09, 0x09, 0x12, 0x00 },
		{ 0x04, 0x1f, 0x04, 0x1f, 0x04, 0x04, 0x04, 0x00 },
		{ 0x00, 0x0f, 0x09, 0x11, 0x01, 0x02, 0x0c, 0x00 },
		{ 0x08, 0x0f, 0x12, 0x02, 0x02, 0x02, 0x04, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x01, 0x01, 0x1f, 0x00 },
		{ 0x0a, 0x1f, 0x0a, 0x0a, 0x02, 0x04, 0x08, 0x00 },
		{ 0x00, 0x18, 0x01, 0x19, 0x01, 0x02, 0x1c, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x02, 0x04, 0x0a, 0x11, 0x00 },
		{ 0x08, 0x1f, 0x09, 0x0a, 0x08, 0x08, 0x07, 0x00 },
		{ 0x00, 0x11, 0x11, 0x09, 0x01, 0x02, 0x0c, 0x00 },
		{ 0x00, 0x0f, 0x09, 0x15, 0x03, 0x02, 0x0c, 0x00 },
		{ 0x02, 0x1c, 0x04, 0x1f, 0x04, 0x04, 0x08, 0x00 },
		{ 0x00, 0x15, 0x15, 0x01, 0x01, 0x02, 0x04, 0x00 },
		{ 0x0e, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x08, 0x00 },
		{ 0x08, 0x08, 0x08, 0x0c, 0x0a, 0x08, 0x08, 0x00 },
		{ 0x04, 0x04, 0x1f, 0x04, 0x04, 0x08, 0x10, 0x00 },
		{ 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x0a, 0x04, 0x0a, 0x10, 0x00 },
		{ 0x04, 0x1f, 0x02, 0x04, 0x0e, 0x15, 0x04, 0x00 },
		{ 0x02, 0x02, 0x02, 0x02, 0x02, 0x04, 0x08, 0x00 },
		{ 0x00, 0x04, 0x02, 0x11, 0x11, 0x11, 0x11, 0x00 },
		{ 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10, 0x0f, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x01, 0x02, 0x0c, 0x00 },
		{ 0x00, 0x08, 0x14, 0x02, 0x01, 0x01, 0x00, 0x00 },
		{ 0x04, 0x1f, 0x04, 0x04, 0x15, 0x15, 0x04, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x0a, 0x04, 0x02, 0x00 },
		{ 0x00, 0x0e, 0x00, 0x0e, 0x00, 0x0e, 0x01, 0x00 },
		{ 0x00, 0x04, 0x08, 0x10, 0x11, 0x1f, 0x01, 0x00 },
		{ 0x00, 0x01, 0x01, 0x0a, 0x04, 0x0a, 0x10, 0x00 },
		{ 0x00, 0x1f, 0x08, 0x1f, 0x08, 0x08, 0x07, 0x00 },
		{ 0x08, 0x08, 0x1f, 0x09, 0x0a, 0x08, 0x08, 0x00 },
		{ 0x00, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x1f, 0x00 },
		{ 0x00, 0x1f, 0x01, 0x1f, 0x01, 0x01, 0x1f, 0x00 },
		{ 0x0e, 0x00, 0x1f, 0x01, 0x01, 0x02, 0x04, 0x00 },
		{ 0x12, 0x12, 0x12, 0x12, 0x02, 0x04, 0x08, 0x00 },
		{ 0x00, 0x04, 0x14, 0x14, 0x15, 0x15, 0x16, 0x00 },
		{ 0x00, 0x10, 0x10, 0x11, 0x12, 0x14, 0x18, 0x00 },
		{ 0x00, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x1f, 0x00 },
		{ 0x00, 0x1f, 0x11, 0x11, 0x01, 0x02, 0x04, 0x00 },
		{ 0x00, 0x18, 0x00, 0x01, 0x01, 0x02, 0x1c, 0x00 },
		{ 0x04, 0x12, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x1c, 0x14, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x00, 0x00, 0x09, 0x15, 0x12, 0x12, 0x0d, 0x00 },
		{ 0x0a, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f, 0x00 },
		{ 0x00, 0x0e, 0x11, 0x1e, 0x11, 0x1e, 0x10, 0x00 },
		{ 0x00, 0x00, 0x0e, 0x10, 0x0c, 0x11, 0x0e, 0x00 },
		{ 0x00, 0x11, 0x11, 0x11, 0x13, 0x1d, 0x10, 0x00 },
		{ 0x00, 0x00, 0x0f, 0x14, 0x12, 0x11, 0x0e, 0x00 },
		{ 0x00, 0x06, 0x09, 0x11, 0x11, 0x1e, 0x10, 0x00 },
		{ 0x00, 0x0f, 0x11, 0x11, 0x11, 0x0f, 0x01, 0x00 },
		{ 0x00, 0x00, 0x07, 0x04, 0x04, 0x14, 0x08, 0x00 },
		{ 0x02, 0x1a, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x02, 0x00, 0x06, 0x02, 0x02, 0x02, 0x02, 0x00 },
		{ 0x00, 0x14, 0x08, 0x14, 0x00, 0x00, 0x00, 0x00 },
		{ 0x04, 0x0e, 0x14, 0x15, 0x0e, 0x04, 0x00, 0x00 },
		{ 0x08, 0x08, 0x1c, 0x08, 0x1c, 0x08, 0x0f, 0x00 },
		{ 0x0e, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0x00 },
		{ 0x0a, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0x00 },
		{ 0x00, 0x16, 0x19, 0x11, 0x11, 0x1e, 0x10, 0x00 },
		{ 0x00, 0x0d, 0x13, 0x11, 0x11, 0x0f, 0x01, 0x00 },
		{ 0x0e, 0x11, 0x1f, 0x11, 0x11, 0x0e, 0x00, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x0b, 0x15, 0x1a, 0x00 },
		{ 0x00, 0x0e, 0x11, 0x11, 0x0a, 0x1b, 0x00, 0x00 },
		{ 0x0a, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0x00 },
		{ 0x1f, 0x10, 0x08, 0x04, 0x08, 0x10, 0x1f, 0x00 },
		{ 0x00, 0x1f, 0x0a, 0x0a, 0x0a, 0x13, 0x00, 0x00 },
		{ 0x1f, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x00 },
		{ 0x00, 0x11, 0x11, 0x11, 0x11, 0x0f, 0x01, 0x00 },
		{ 0x01, 0x1e, 0x04, 0x1f, 0x04, 0x04, 0x00, 0x00 },
		{ 0x00, 0x1f, 0x08, 0x0f, 0x09, 0x11, 0x00, 0x00 },
		{ 0x00, 0x1f, 0x15, 0x1f, 0x11, 0x11, 0x00, 0x00 },
		{ 0x00, 0x00, 0x04, 0x00, 0x1f, 0x00, 0x04, 0x00 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 },
		{ 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x00 },
	};


	/* Calculate target SEGMENT Nr (Characters are always 5 segments wide) */
	BYTE line        = 0;
	WORD segmentNr   = 5 * index;
	BYTE displayData = self->DD_RAM[index];

	if (self->bTwoLineMode) {
		line = (index < MemoryPerRow) ? 0 : 1;
		segmentNr = 5 * (index % MemoryPerRow);
	}

	/* Transpose a "font-by-row" bitmap into "font-by-colum" bitmap */
	const uint8_t * const pFontChar = displayData < 0x10 ? &self->CG_RAM[displayData / 8] : &fontA00[displayData - 0x10][0];
	int nCharRows = (self->view->controllerDuty == 11) ? 11 : 8;

	WORD pixel_bm = 1; // Pixel BitMask
	WORD pixels1 = 0, pixels2 = 0, pixels3 = 0, pixels4 = 0, pixels5 = 0;
	for (int fontRow = 0; fontRow < nCharRows; fontRow++) {
		uint8_t fontData = pFontChar[fontRow];
		pixels1 |= (fontData & (1 << 4)) ? pixel_bm : 0;
		pixels2 |= (fontData & (1 << 3)) ? pixel_bm : 0;
		pixels3 |= (fontData & (1 << 2)) ? pixel_bm : 0;
		pixels4 |= (fontData & (1 << 1)) ? pixel_bm : 0;
		pixels5 |= (fontData & (1 << 0)) ? pixel_bm : 0;
		pixel_bm <<= 1;
	}
	segview_StoreSegment(self->view, segmentNr++, pixels1, line);
	segview_StoreSegment(self->view, segmentNr++, pixels2, line);
	segview_StoreSegment(self->view, segmentNr++, pixels3, line);
	segview_StoreSegment(self->view, segmentNr++, pixels4, line);
	segview_StoreSegment(self->view, segmentNr++, pixels5, line);
}
