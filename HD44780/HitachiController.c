//-----------------------------------------------------------------------------*
// Copyright © 2023 Kane International Ltd.
// Instrument	: KANE Combustion Analyser
// FILE			: HitachiController.c
// ENCODING		: ISO 8859-1
// DESCRIPTION	: Hitachi HD44780 LCD Controller Simulator.
// CREATED		: 2023-04-10
// AUTHOR		: Nigel Winterbottom
// CPU TYPE		: ANY
// COMPILER		: ANY
// COMMENTS		:
//-----------------------------------------------------------------------------*


/* Implements *****************************************************************/
#include "HitachiController.h"

/* Dependencies ***************************************************************/
#include <stdint.h>



/* Local Types ****************************************************************/
/* Local Variables ************************************************************/
SegmentView   view;



/* Local functions ---------------------------------------------------------*/




/**
 * Initilaise the GUI Element.
 */
 
 
 
 namespace HD44780Lcd.Controller
{
    public class CharacterLcdController
    {
        public const int MemoryPerRow = 40;
        protected CharacterLcdDisplay LcdDisplay;
        public char[] Memory;
        public int DDRamAddress { get; protected set; }
        public int CGRamAddress { get; protected set; }
        public int ScrollOffset { get; protected set; }

        private bool IncreaseCursor = true;
        private bool AutoScrollDisplay = false;

        public CharacterLcdController(CharacterLcdDisplay lcd)
        {
            LcdDisplay = lcd;
            SetLines(1);
        }

        public void SetLines(int n)
        {
            LcdDisplay.SetLines(n);
            Memory = new char[LcdDisplay.CharactersY * MemoryPerRow];
            UpdateLcd();
        }

        public void SetText(int address, string text)
        {
            for (int n = 0; n < text.Length; ++n)
            {
                Memory[n % Memory.Length] = text[n];
            }
            UpdateLcd();
        }

        private void UpdateLcd()
        {
            int scroll = ScrollOffset;
            for (int y = 0; y < LcdDisplay.CharactersY; ++y)
            {
                for (int x = 0; x < LcdDisplay.CharactersX; ++x)
                {
                    LcdDisplay[x, y] = Memory[y * MemoryPerRow + (x - scroll + MemoryPerRow) % MemoryPerRow];
                }
            }

            LcdDisplay.CursorX = (DDRamAddress + scroll + MemoryPerRow) % MemoryPerRow;
            LcdDisplay.CursorY = (DDRamAddress) / MemoryPerRow;
        }

        internal void AddData(byte data)
        {
            Memory[DDRamAddress] = (char)data;
            if (IncreaseCursor)
            {
                if (++DDRamAddress >= Memory.Length) DDRamAddress = 0;
            }
            else
            {
                if (--DDRamAddress < 0) DDRamAddress += Memory.Length;
            }
            if (AutoScrollDisplay) ScrollDisplay(-1);
            UpdateLcd();
        }

        internal void SetDDRamAddress(int address)
        {
            DDRamAddress = address;
            while (DDRamAddress < 0) DDRamAddress += Memory.Length;
            while (DDRamAddress >= Memory.Length) DDRamAddress -= Memory.Length;
            UpdateLcd();
        }

        internal void SetCGRamAddress(int address)
        {
            CGRamAddress = address;
            UpdateLcd();
        }

        internal void SetDisplay(bool displayOn, bool cursorOn, bool blinkOn)
        {
            LcdDisplay.DisplayOn = displayOn;
            LcdDisplay.ShowCursor = cursorOn;
            LcdDisplay.BlinkCursor = blinkOn;
            UpdateLcd();
        }

        internal void ScrollDisplay(int n)
        {
            ScrollOffset += n;
            while (ScrollOffset < 0) ScrollOffset += MemoryPerRow;
            while (ScrollOffset >= MemoryPerRow) ScrollOffset -= MemoryPerRow;

            UpdateLcd();
        }

        internal void ScrollCursor(int n)
        {
            SetDDRamAddress(DDRamAddress + n);
            UpdateLcd();
        }

        internal void SetEntryMode(bool increaseCursor, bool scrollDisplay)
        {
            IncreaseCursor = increaseCursor;
            AutoScrollDisplay = scrollDisplay;
        }

        internal void CursorHome()
        {
            ScrollOffset = 0;
            DDRamAddress = 0;
            UpdateLcd();
        }

        internal void ClearDisplay()
        {
            for (int i = 0; i < Memory.Length; ++i) Memory[i] = (char)0;
            DDRamAddress = 0;
            ScrollOffset = 0;
            UpdateLcd();
        }

    }
}

 
namespace HD44780Lcd.Controller
{
    public class HD44780LcdController
    {
        private enum BitMode
        {
            Four,
            Eight
        }

        private CharacterLcdController LcdController;

        private BitMode Mode;
        private bool ReadHighNibble;
        private int Data;

        HD44780Pins pins;

        public HD44780LcdController(CharacterLcdController lcdController,
                                    HD44780Pins pins)
        {
            Mode = BitMode.Eight;
            LcdController = lcdController;

            this.pins = pins;

            // set the event handler for all pins
            pins.PinE.PinChanged += Pins_PinChanged;
            pins.PinRS.PinChanged += Pins_PinChanged;
            pins.PinRW.PinChanged += Pins_PinChanged;

            for (int i = 0; i < 8; i++)
                pins.PinData[i].PinChanged += Pins_PinChanged;        
        }

        //public void SetDataPins(params ATMegaPins.Pins[] pins)
        //{
        //    if (pins.Length != 4 && pins.Length != 8)
        //    {
        //        throw new ArgumentException("Number of data pins must be 4 or 8.");
        //    }

        //    if (pins.Length == 4)
        //    {
        //        pins = pins.Concat(new ATMegaPins.Pins[] { ATMegaPins.Pins.NotConnected, ATMegaPins.Pins.NotConnected, ATMegaPins.Pins.NotConnected, ATMegaPins.Pins.NotConnected }).ToArray();
        //    }

        //    PinData = pins;
        //}

        //public ATMegaPins.Pins[] GetDataPins()
        //{
        //    return (ATMegaPins.Pins[])PinData.Clone();
        //}

        void Pins_PinChanged(object sender, PinChangedEventArgs e)
        {
            if (sender == pins.PinE && e.Level == PowerLevel.LOW)
            {
                if (Mode == BitMode.Eight || (Mode == BitMode.Four && ReadHighNibble))
                {
                    Data = 0;
                }

                if (Mode == BitMode.Eight)
                {
                    for (int i = 0; i < 8; ++i)
                        Data |= ((pins.PinData[i].Level == PowerLevel.HIGH) ? 1 : 0) << (7 - i);
                }
                else if (Mode == BitMode.Four)
                {
                    Data <<= 4;
                    for (int i = 0; i < 4; ++i)
                        Data |= ((pins.PinData[i].Level == PowerLevel.HIGH) ? 1 : 0) << (3 - i);
                }

                if (Mode == BitMode.Eight || (Mode == BitMode.Four && !ReadHighNibble))
                {
                    if (pins.PinRS.Level == PowerLevel.HIGH)
                    {
                        LcdDebug.LogData(Mode, Data);
                        HandleData((byte)Data);
                    }
                    else
                    {
                        LcdDebug.LogInstruction(Mode, Data);
                        HandleInstruction((byte)Data);
                    }
                }

                if (Mode == BitMode.Four) ReadHighNibble = !ReadHighNibble;
            }
        }

        private void HandleInstruction(byte instr)
        {
            if ((instr & 0x80) != 0)
                SetDDRamAddress(instr & 0x7F);
            else if ((instr & 0x40) != 0)
                SetCGRamAddress(instr & 0x3F);
            else if ((instr & 0x20) != 0)
                FunctionSet(instr & 0x1F);
            else if ((instr & 0x10) != 0)
                Shift(instr & 0x0F);
            else if ((instr & 0x08) != 0)
                SetDisplay(instr & 0x07);
            else if ((instr & 0x04) != 0)
                SetEntryMode(instr & 0x03);
            else if ((instr & 0x02) != 0)
                CursorHome();
            else if ((instr & 0x01) != 0)
                ClearDisplay();
        }

        private void HandleData(byte data)
        {
            LcdController.AddData(data);
        }

        private void SetDDRamAddress(int address)
        {
            // HD44780 uses 0 .. 39 for line one
            // and 64 .. 103 for line two
            if (address > 39 && address < 64) address = 40;
            if (address >= 64) address = address - 64 + 40;

            LcdController.SetDDRamAddress(address);
        }

        private void SetCGRamAddress(int address)
        {
            LcdController.SetCGRamAddress(address);
        }

        private void FunctionSet(int instr)
        {
            Mode = ((instr & 0x10) != 0) ? BitMode.Eight : BitMode.Four;
            int lines = ((instr & 0x08) != 0) ? 2 : 1;
            LcdController.SetLines(lines);

            if (Mode == BitMode.Four) ReadHighNibble = false;
        }

        private void Shift(int instr)
        {
            int offset;
            if ((instr & 0x04) != 0)
                offset = +1;
            else
                offset = -1;

            if ((instr & 0x08) != 0)
                LcdController.ScrollDisplay(offset);
            else
                LcdController.ScrollCursor(offset);
        }

        private void SetDisplay(int instr)
        {
            bool displayOn = (instr & 0x4) != 0;
            bool cursorOn = (instr & 0x2) != 0;
            bool blinkOn = (instr & 0x1) != 0;
            LcdController.SetDisplay(displayOn, cursorOn, blinkOn);
        }

        private void SetEntryMode(int instr)
        {
            bool increaseCursor = ((instr & 0x2) != 0);
            bool scrollDisplay = ((instr & 0x1) != 0);
            LcdController.SetEntryMode(increaseCursor, scrollDisplay);
        }

        private void CursorHome()
        {
            LcdController.CursorHome();
        }

        private void ClearDisplay()
        {
            LcdController.ClearDisplay();
        }

        private static class LcdDebug
        {
            internal static bool LoggingEnabled = true;

            internal static void LogData(BitMode mode, int data)
            {
                if (!LoggingEnabled) return;
                
                char c = (char)data;
                if(c < ' ' || c > '~') c = ' ';
                LogLine("data", mode, string.Concat(data.ToString(), ", 0x", data.ToString("X"), " (", c.ToString(), ")"));
            }

            internal static void LogInstruction(BitMode mode, int data)
            {
                if (!LoggingEnabled) return;

                LogLine("inst", mode, GetInstruction(data));
            }

            private static void LogLine(string type, BitMode mode, string msg)
            {
                Console.WriteLine(string.Concat("LCD [", type,"] [", GetModeStr(mode), "]: ", msg));
            }

            private static string GetModeStr(BitMode mode)
            {
                switch (mode)
                {
                    case BitMode.Four:
                        return "4 bit";
                    case BitMode.Eight:
                        return "8 bit";
                    default:
                        return "? bit";
                }
            }

            private static string GetInstruction(int instr)
            {
                if ((instr & 0x80) != 0)
                    return GetDDRamAddressInstruction(instr & 0x7F);
                else if ((instr & 0x40) != 0)
                    return GetCGRamAddressInstruction(instr & 0x3F);
                else if ((instr & 0x20) != 0)
                    return GetFunctionSetInstruction(instr & 0x1F);
                else if ((instr & 0x10) != 0)
                    return GetShiftInstruction(instr & 0x0F);
                else if ((instr & 0x08) != 0)
                    return GetDisplayInstruction(instr & 0x07);
                else if ((instr & 0x04) != 0)
                    return GetEntryModeInstruction(instr & 0x03);
                else if ((instr & 0x02) != 0)
                    return "Cursor Home";
                else if ((instr & 0x01) != 0)
                    return "Clear Display";

                return "Invalid instruction";
            }

            private static string GetDDRamAddressInstruction(int p)
            {
                return string.Concat("Set DDRAM address to ", p.ToString());
            }

            private static string GetCGRamAddressInstruction(int p)
            {
                return string.Concat("Set CGRAM address to ", p.ToString());
            }

            private static string GetFunctionSetInstruction(int p)
            {
                return string.Concat("Set mode: ",
                    ((p & 0x10) != 0) ? "8 bit" : "4 bit",
                    ((p & 0x08) != 0) ? ", 2 lines" : ", 1 line",
                    ((p & 0x04) != 0) ? ", 5x10 font" : ", 5x8 font"
                    );
            }

            private static string GetShiftInstruction(int p)
            {
                return string.Concat("Shift ",
                    ((p & 0x8) != 0) ? "display " : "cursor ",
                    ((p & 0x4) != 0) ? "right" : "left");
            }

            private static string GetDisplayInstruction(int p)
            {
                return string.Concat("Set display: ",
                    ((p & 0x4) != 0) ? "on" : "off",
                    ", cursor: ",
                    ((p & 0x2) != 0) ? "on" : "off",
                    ", blink: ",
                    ((p & 0x1) != 0) ? "on" : "off"
                    );
            }

            private static string GetEntryModeInstruction(int p)
            {
                return string.Concat("Entry mode: ",
                    ((p & 0x2) != 0) ? "increase" : "decrease", " cursor position",
                    ", scroll display ", ((p & 0x1) != 0) ? "on" : "off");
            }
        }

    }
}

void segview_CreateController (SegmentView *self, HINSTANCE hInst, HWND hParent)
{
	static const uint8_t Characters[][8] = {

		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0 },
		{ 0x00, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x0a, 0x0a, 0x1f, 0x0a, 0x1f, 0x0a, 0x0a, 0 },
		{ 0x04, 0x0f, 0x14, 0x0e, 0x05, 0x1e, 0x04, 0 },
		{ 0x18, 0x19, 0x02, 0x04, 0x08, 0x13, 0x03, 0 },
		{ 0x0c, 0x12, 0x14, 0x08, 0x15, 0x12, 0x0d, 0 },
		{ 0x0c, 0x04, 0x08, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x02, 0x04, 0x08, 0x08, 0x08, 0x04, 0x02, 0 },
		{ 0x08, 0x04, 0x02, 0x02, 0x02, 0x04, 0x08, 0 },
		{ 0x00, 0x04, 0x15, 0x0e, 0x15, 0x04, 0x00, 0 },
		{ 0x00, 0x04, 0x04, 0x1f, 0x04, 0x04, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x0c, 0x04, 0x08, 0 },
		{ 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0 },
		{ 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x00, 0 },
		{ 0x0e, 0x11, 0x13, 0x15, 0x19, 0x11, 0x0e, 0 },
		{ 0x04, 0x0c, 0x04, 0x04, 0x04, 0x04, 0x0e, 0 },
		{ 0x0e, 0x11, 0x01, 0x02, 0x04, 0x08, 0x1f, 0 },
		{ 0x1f, 0x02, 0x04, 0x02, 0x01, 0x11, 0x0e, 0 },
		{ 0x02, 0x06, 0x0a, 0x12, 0x1f, 0x02, 0x02, 0 },
		{ 0x1f, 0x10, 0x1e, 0x01, 0x01, 0x11, 0x0e, 0 },
		{ 0x06, 0x08, 0x10, 0x1e, 0x11, 0x11, 0x0e, 0 },
		{ 0x1f, 0x01, 0x02, 0x04, 0x08, 0x08, 0x08, 0 },
		{ 0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e, 0 },
		{ 0x0e, 0x11, 0x11, 0x0f, 0x01, 0x02, 0x0c, 0 },
		{ 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x0c, 0x00, 0 },
		{ 0x00, 0x0c, 0x0c, 0x00, 0x0c, 0x04, 0x08, 0 },
		{ 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0 },
		{ 0x00, 0x00, 0x1f, 0x00, 0x1f, 0x00, 0x00, 0 },
		{ 0x10, 0x08, 0x04, 0x02, 0x04, 0x08, 0x10, 0 },
		{ 0x0e, 0x11, 0x01, 0x02, 0x04, 0x00, 0x04, 0 },
		{ 0x0e, 0x11, 0x01, 0x0d, 0x15, 0x15, 0x0e, 0 },
		{ 0x0e, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0 },
		{ 0x1e, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x1e, 0 },
		{ 0x0e, 0x11, 0x10, 0x10, 0x10, 0x11, 0x0e, 0 },
		{ 0x1e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1e, 0 },
		{ 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x1f, 0 },
		{ 0x1f, 0x10, 0x10, 0x1e, 0x10, 0x10, 0x10, 0 },
		{ 0x0e, 0x11, 0x10, 0x17, 0x11, 0x11, 0x0f, 0 },
		{ 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0 },
		{ 0x0e, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0 },
		{ 0x07, 0x02, 0x02, 0x02, 0x02, 0x12, 0x0c, 0 },
		{ 0x11, 0x12, 0x14, 0x18, 0x14, 0x12, 0x11, 0 },
		{ 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1f, 0 },
		{ 0x11, 0x1b, 0x15, 0x15, 0x11, 0x11, 0x11, 0 },
		{ 0x11, 0x11, 0x19, 0x15, 0x13, 0x11, 0x11, 0 },
		{ 0x0e, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0 },
		{ 0x1e, 0x11, 0x11, 0x1e, 0x10, 0x10, 0x10, 0 },
		{ 0x0e, 0x11, 0x11, 0x11, 0x15, 0x12, 0x0d, 0 },
		{ 0x1e, 0x11, 0x11, 0x1e, 0x14, 0x12, 0x11, 0 },
		{ 0x0f, 0x10, 0x10, 0x0e, 0x01, 0x01, 0x1e, 0 },
		{ 0x1f, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0 },
		{ 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0 },
		{ 0x11, 0x11, 0x11, 0x11, 0x11, 0x0a, 0x04, 0 },
		{ 0x11, 0x11, 0x11, 0x15, 0x15, 0x15, 0x0a, 0 },
		{ 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0 },
		{ 0x11, 0x11, 0x11, 0x0a, 0x04, 0x04, 0x04, 0 },
		{ 0x1f, 0x01, 0x02, 0x04, 0x08, 0x10, 0x1f, 0 },
		{ 0x0e, 0x08, 0x08, 0x08, 0x08, 0x08, 0x0e, 0 },
		{ 0x11, 0x0a, 0x1f, 0x04, 0x1f, 0x04, 0x04, 0 },
		{ 0x0e, 0x02, 0x02, 0x02, 0x02, 0x02, 0x0e, 0 },
		{ 0x04, 0x0a, 0x11, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0 },
		{ 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f, 0 },
		{ 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x1e, 0 },
		{ 0x00, 0x00, 0x0e, 0x10, 0x10, 0x11, 0x0e, 0 },
		{ 0x01, 0x01, 0x0d, 0x13, 0x11, 0x11, 0x0f, 0 },
		{ 0x00, 0x00, 0x0e, 0x11, 0x1f, 0x10, 0x0e, 0 },
		{ 0x06, 0x09, 0x08, 0x1c, 0x08, 0x08, 0x08, 0 },
		{ 0x00, 0x00, 0x0f, 0x11, 0x0f, 0x01, 0x0e, 0 },
		{ 0x10, 0x10, 0x16, 0x19, 0x11, 0x11, 0x11, 0 },
		{ 0x04, 0x00, 0x0c, 0x04, 0x04, 0x04, 0x0e, 0 },
		{ 0x02, 0x06, 0x02, 0x02, 0x02, 0x12, 0x0c, 0 },
		{ 0x10, 0x10, 0x12, 0x14, 0x18, 0x14, 0x12, 0 },
		{ 0x0c, 0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0 },
		{ 0x00, 0x00, 0x1a, 0x15, 0x15, 0x11, 0x11, 0 },
		{ 0x00, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0 },
		{ 0x00, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0 },
		{ 0x00, 0x00, 0x1e, 0x11, 0x1e, 0x10, 0x10, 0 },
		{ 0x00, 0x00, 0x0d, 0x13, 0x0f, 0x01, 0x01, 0 },
		{ 0x00, 0x00, 0x16, 0x19, 0x10, 0x10, 0x10, 0 },
		{ 0x00, 0x00, 0x0f, 0x10, 0x0e, 0x01, 0x1e, 0 },
		{ 0x08, 0x08, 0x1c, 0x08, 0x08, 0x09, 0x06, 0 },
		{ 0x00, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0 },
		{ 0x00, 0x00, 0x11, 0x11, 0x11, 0x0a, 0x04, 0 },
		{ 0x00, 0x00, 0x11, 0x11, 0x15, 0x15, 0x0a, 0 },
		{ 0x00, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0 },
		{ 0x00, 0x00, 0x11, 0x11, 0x0f, 0x01, 0x0e, 0 },
		{ 0x00, 0x00, 0x1f, 0x02, 0x04, 0x08, 0x1f, 0 },
		{ 0x02, 0x04, 0x04, 0x08, 0x04, 0x04, 0x02, 0 },
		{ 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0x04, 0 },
		{ 0x08, 0x04, 0x04, 0x02, 0x04, 0x04, 0x08, 0 },
		{ 0x00, 0x04, 0x02, 0x1f, 0x02, 0x04, 0x00, 0 },
		{ 0x00, 0x04, 0x08, 0x1f, 0x08, 0x04, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 }, // CharCode 0x80
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x1c, 0x14, 0x1c, 0 },
		{ 0x07, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x1c, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x10, 0x08, 0x04, 0 },
		{ 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x00, 0x00, 0 },
		{ 0x00, 0x1f, 0x01, 0x1f, 0x01, 0x02, 0x04, 0 },
		{ 0x00, 0x00, 0x1f, 0x01, 0x06, 0x04, 0x08, 0 },
		{ 0x00, 0x00, 0x02, 0x04, 0x0c, 0x14, 0x04, 0 },
		{ 0x00, 0x00, 0x04, 0x1f, 0x11, 0x01, 0x06, 0 },
		{ 0x00, 0x00, 0x00, 0x1f, 0x04, 0x04, 0x1f, 0 },
		{ 0x00, 0x00, 0x02, 0x1f, 0x06, 0x0a, 0x12, 0 },
		{ 0x00, 0x00, 0x08, 0x1f, 0x09, 0x0a, 0x08, 0 },
		{ 0x00, 0x00, 0x00, 0x0e, 0x02, 0x02, 0x1f, 0 },
		{ 0x00, 0x00, 0x1e, 0x02, 0x1e, 0x02, 0x1e, 0 },
		{ 0x00, 0x00, 0x00, 0x15, 0x15, 0x01, 0x06, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x1f, 0x00, 0x00, 0 },
		{ 0x1f, 0x01, 0x05, 0x06, 0x04, 0x04, 0x08, 0 },
		{ 0x01, 0x02, 0x04, 0x0c, 0x14, 0x04, 0x04, 0 },
		{ 0x04, 0x1f, 0x11, 0x11, 0x01, 0x02, 0x04, 0 },
		{ 0x00, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x1f, 0 },
		{ 0x02, 0x1f, 0x02, 0x06, 0x0a, 0x12, 0x02, 0 },
		{ 0x08, 0x1f, 0x09, 0x09, 0x09, 0x09, 0x12, 0 },
		{ 0x04, 0x1f, 0x04, 0x1f, 0x04, 0x04, 0x04, 0 },
		{ 0x00, 0x0f, 0x09, 0x11, 0x01, 0x02, 0x0c, 0 },
		{ 0x08, 0x0f, 0x12, 0x02, 0x02, 0x02, 0x04, 0 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x01, 0x01, 0x1f, 0 },
		{ 0x0a, 0x1f, 0x0a, 0x0a, 0x02, 0x04, 0x08, 0 },
		{ 0x00, 0x18, 0x01, 0x19, 0x01, 0x02, 0x1c, 0 },
		{ 0x00, 0x1f, 0x01, 0x02, 0x04, 0x0a, 0x11, 0 },
		{ 0x08, 0x1f, 0x09, 0x0a, 0x08, 0x08, 0x07, 0 },
		{ 0x00, 0x11, 0x11, 0x09, 0x01, 0x02, 0x0c, 0 },
		{ 0x00, 0x0f, 0x09, 0x15, 0x03, 0x02, 0x0c, 0 },
		{ 0x02, 0x1c, 0x04, 0x1f, 0x04, 0x04, 0x08, 0 },
		{ 0x00, 0x15, 0x15, 0x01, 0x01, 0x02, 0x04, 0 },
		{ 0x0e, 0x00, 0x1f, 0x04, 0x04, 0x04, 0x08, 0 },
		{ 0x08, 0x08, 0x08, 0x0c, 0x0a, 0x08, 0x08, 0 },
		{ 0x04, 0x04, 0x1f, 0x04, 0x04, 0x08, 0x10, 0 },
		{ 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00, 0x1f, 0 },
		{ 0x00, 0x1f, 0x01, 0x0a, 0x04, 0x0a, 0x10, 0 },
		{ 0x04, 0x1f, 0x02, 0x04, 0x0e, 0x15, 0x04, 0 },
		{ 0x02, 0x02, 0x02, 0x02, 0x02, 0x04, 0x08, 0 },
		{ 0x00, 0x04, 0x02, 0x11, 0x11, 0x11, 0x11, 0 },
		{ 0x10, 0x10, 0x1f, 0x10, 0x10, 0x10, 0x0f, 0 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x01, 0x02, 0x0c, 0 },
		{ 0x00, 0x08, 0x14, 0x02, 0x01, 0x01, 0x00, 0 },
		{ 0x04, 0x1f, 0x04, 0x04, 0x15, 0x15, 0x04, 0 },
		{ 0x00, 0x1f, 0x01, 0x01, 0x0a, 0x04, 0x02, 0 },
		{ 0x00, 0x0e, 0x00, 0x0e, 0x00, 0x0e, 0x01, 0 },
		{ 0x00, 0x04, 0x08, 0x10, 0x11, 0x1f, 0x01, 0 },
		{ 0x00, 0x01, 0x01, 0x0a, 0x04, 0x0a, 0x10, 0 },
		{ 0x00, 0x1f, 0x08, 0x1f, 0x08, 0x08, 0x07, 0 },
		{ 0x08, 0x08, 0x1f, 0x09, 0x0a, 0x08, 0x08, 0 },
		{ 0x00, 0x0e, 0x02, 0x02, 0x02, 0x02, 0x1f, 0 },
		{ 0x00, 0x1f, 0x01, 0x1f, 0x01, 0x01, 0x1f, 0 },
		{ 0x0e, 0x00, 0x1f, 0x01, 0x01, 0x02, 0x04, 0 },
		{ 0x12, 0x12, 0x12, 0x12, 0x02, 0x04, 0x08, 0 },
		{ 0x00, 0x04, 0x14, 0x14, 0x15, 0x15, 0x16, 0 },
		{ 0x00, 0x10, 0x10, 0x11, 0x12, 0x14, 0x18, 0 },
		{ 0x00, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x1f, 0 },
		{ 0x00, 0x1f, 0x11, 0x11, 0x01, 0x02, 0x04, 0 },
		{ 0x00, 0x18, 0x00, 0x01, 0x01, 0x02, 0x1c, 0 },
		{ 0x04, 0x12, 0x08, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x1c, 0x14, 0x1c, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x00, 0x00, 0x09, 0x15, 0x12, 0x12, 0x0d, 0 },
		{ 0x0a, 0x00, 0x0e, 0x01, 0x0f, 0x11, 0x0f, 0 },
		{ 0x00, 0x0e, 0x11, 0x1e, 0x11, 0x1e, 0x10, 0 },
		{ 0x00, 0x00, 0x0e, 0x10, 0x0c, 0x11, 0x0e, 0 },
		{ 0x00, 0x11, 0x11, 0x11, 0x13, 0x1d, 0x10, 0 },
		{ 0x00, 0x00, 0x0f, 0x14, 0x12, 0x11, 0x0e, 0 },
		{ 0x00, 0x06, 0x09, 0x11, 0x11, 0x1e, 0x10, 0 },
		{ 0x00, 0x0f, 0x11, 0x11, 0x11, 0x0f, 0x01, 0 },
		{ 0x00, 0x00, 0x07, 0x04, 0x04, 0x14, 0x08, 0 },
		{ 0x02, 0x1a, 0x02, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x02, 0x00, 0x06, 0x02, 0x02, 0x02, 0x02, 0 },
		{ 0x00, 0x14, 0x08, 0x14, 0x00, 0x00, 0x00, 0 },
		{ 0x04, 0x0e, 0x14, 0x15, 0x0e, 0x04, 0x00, 0 },
		{ 0x08, 0x08, 0x1c, 0x08, 0x1c, 0x08, 0x0f, 0 },
		{ 0x0e, 0x00, 0x16, 0x19, 0x11, 0x11, 0x11, 0 },
		{ 0x0a, 0x00, 0x0e, 0x11, 0x11, 0x11, 0x0e, 0 },
		{ 0x00, 0x16, 0x19, 0x11, 0x11, 0x1e, 0x10, 0 },
		{ 0x00, 0x0d, 0x13, 0x11, 0x11, 0x0f, 0x01, 0 },
		{ 0x0e, 0x11, 0x1f, 0x11, 0x11, 0x0e, 0x00, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x0b, 0x15, 0x1a, 0 },
		{ 0x00, 0x0e, 0x11, 0x11, 0x0a, 0x1b, 0x00, 0 },
		{ 0x0a, 0x00, 0x11, 0x11, 0x11, 0x13, 0x0d, 0 },
		{ 0x1f, 0x10, 0x08, 0x04, 0x08, 0x10, 0x1f, 0 },
		{ 0x00, 0x1f, 0x0a, 0x0a, 0x0a, 0x13, 0x00, 0 },
		{ 0x1f, 0x00, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0 },
		{ 0x00, 0x11, 0x11, 0x11, 0x11, 0x0f, 0x01, 0 },
		{ 0x01, 0x1e, 0x04, 0x1f, 0x04, 0x04, 0x00, 0 },
		{ 0x00, 0x1f, 0x08, 0x0f, 0x09, 0x11, 0x00, 0 },
		{ 0x00, 0x1f, 0x15, 0x1f, 0x11, 0x11, 0x00, 0 },
		{ 0x00, 0x00, 0x04, 0x00, 0x1f, 0x00, 0x04, 0 },
		{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0 },
		{ 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0x1f, 0 },

	};

	for (int character = 0; character < 30; character++) {
		for (int backplane = 0; backplane < 8; backplane++) {
			self->_segments[character][backplane + 0] = Characters[character + 0x11][backplane];
			self->_segments[character][backplane + 8] = Characters[character + 0x41][backplane];
		}
	}



}


public HD44780Pins()
{
	_pinE.Name = "E";
	_pinE.PinIndex = 1;

	_pinRS.Name = "RS";
	_pinRS.PinIndex = 2;

	_pinRW.Name = "RW";
	_pinRW.PinIndex = 3;

	for (int i = 0; i < _pinData.Length; i++)
		_pinData[i] = new Pin();

	_pinData[0].Name = "DATA0";
	_pinData[0].PinIndex = 4;

	_pinData[1].Name = "DATA1";
	_pinData[1].PinIndex = 5;

	_pinData[2].Name = "DATA2";
	_pinData[2].PinIndex = 6;

	_pinData[3].Name = "DATA3";
	_pinData[3].PinIndex = 7;

	_pinData[4].Name = "DATA4";
	_pinData[4].PinIndex = 8;

	_pinData[5].Name = "DATA5";
	_pinData[5].PinIndex = 9;

	_pinData[6].Name = "DATA6";
	_pinData[6].PinIndex = 10;

	_pinData[7].Name = "DATA7";
	_pinData[7].PinIndex = 11;
}



/**
 * @fn		DrawPixels
 * @brief	Draw one 5x7-Pixel Character.
 * @param	segmentIdx: 0x00 - 0x27.
 */
